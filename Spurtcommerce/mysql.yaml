---
- name: Installing mysql server
  hosts: database
  become: yes
  tasks:
    - name: Installing mysql 
      apt:
        name: mysql-server
        state: present
    - name: Install python3-PyMySQL library
      apt:
        name: python3-pymysql
        state: present
    - name: checking the plugin for root
      ansible.builtin.shell:
        cmd: mysql -Nse "select count(*) from mysql.user where user = 'root' and authentication_string is null"
      ignore_errors: yes
      register: root_password
    - name: print rootpassword
      ansible.builtin.debug:
        var: root_password.stdout
    - name: Change the authentication plugin of MySQL root user to mysql_native_password
      ansible.builtin.shell:
        cmd: mysql -Nse 'UPDATE mysql.user SET plugin="mysql_native_password" WHERE user="root" AND host="localhost"'
      ignore_errors: yes
    - name: Flush Privileges
      ansible.builtin.shell:
        cmd: mysql -u root -e 'FLUSH PRIVILEGES'
      ignore_errors: yes
      notify:
        - Restart mysql
    - name: Set MySQL root Password
      mysql_user:
        check_implicit_admin: yes
        login_host: 'localhost'
        login_user: 'root'
        login_password: ''
        name: 'root'
        password: 'testuser@123'
        state: present
      ignore_errors: yes
      notify:
        - Restart mysql
  handlers:
    - name: Restart mysql
      ansible.builtin.systemd:
        name: 'mysql.service'
        daemon_reload: yes
        enabled: yes
        state: restarted